%% =========================================================================
% 0) Pulse Grid CSV íŒŒì¼ ì„ íƒ
% =========================================================================
base_dir = 'G:\ê³µìœ  ë“œë¼ì´ë¸Œ\Battery Software Group (2025)\Members\ìµœì€ì‹\COMSOL\MSCC_optimization\Pulse_opt';
assert(isfolder(base_dir), 'í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: %s', base_dir);

[fn, fp] = uigetfile(fullfile(base_dir, '*.csv'), ...
                     'Pulse Grid CSV íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”');

if isequal(fn, 0)
    error('íŒŒì¼ ì„ íƒì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
end

fullpath_csv = fullfile(fp, fn);
fprintf('ì„ íƒí•œ CSV: %s\n', fullpath_csv);


%% =========================================================================
% 1) CSV ë¡œë“œ
% =========================================================================
T = readtable(fullpath_csv);

% í•„ìˆ˜ ì»¬ëŸ¼
stage = T.stage_mode;
duty  = T.duty;
Tper  = T.pulse_period_s;
dplat = T.d_plating;    % = plating_cap - plating_cap_base

% ğŸ”¹ stage_mode 1~7ë§Œ ì‚¬ìš© (0 = baselineì€ ì œì™¸)
stage_list = setdiff(unique(stage), 0);   % ë˜ëŠ” ê·¸ëƒ¥: stage_list = (1:7)';

fprintf('\nì´ stage_mode ì¢…ë¥˜ (0 ì œì™¸): '); disp(stage_list');

fig_id = 1;

%% =========================================================================
% 2) stage_mode = 1~7 ëª¨ë“  ëª¨ë“œ ë°˜ë³µ
% =========================================================================
for mode_target = stage_list'

    fprintf('\n==============================================\n');
    fprintf('>> stage_mode = %d ì²˜ë¦¬ì¤‘...\n', mode_target);
    fprintf('==============================================\n');

    % ì¸ë±ì‹±
    idx = (stage == mode_target);

    duty_f  = duty(idx);
    Tper_f  = Tper(idx);
    dplat_f = dplat(idx);

    fprintf('stage_mode = %d ë°ì´í„° ê°œìˆ˜: %d\n', ...
            mode_target, sum(idx));

    % í˜¹ì‹œë¼ë„ ë°ì´í„° ì—†ìœ¼ë©´ ìŠ¤í‚µ
    if isempty(duty_f)
        warning('stage_mode %d ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìŠ¤í‚µí•©ë‹ˆë‹¤.', mode_target);
        continue;
    end

    %% =========================================================================
    % 3) duty Ã— Tper grid êµ¬ì„±
    %% =========================================================================
    duty_u = unique(duty_f);
    Tper_u = unique(Tper_f);

    [DUTY, TPER] = meshgrid(duty_u, Tper_u);

    Z = nan(size(DUTY));
    for i = 1:numel(duty_f)
        rr = find(Tper_u == Tper_f(i));
        cc = find(duty_u == duty_f(i));
        Z(rr, cc) = dplat_f(i);
    end

    %% =========================================================================
    % 4) 3D Surface Plot
    %% =========================================================================
    figure(fig_id); clf; set(gcf,'Color','w');
    fig_id = fig_id + 1;

    surf(DUTY, TPER, Z, 'FaceAlpha',0.9);
    shading interp;
    colorbar;

    xlabel('Duty');
    ylabel('Pulse Period (s)');
    zlabel('\DeltaPlating');
    title(sprintf('MSCC4 Pulse Grid (stage mode = %d)', mode_target));

    set(gca,'YScale','log');   % Tper log ìŠ¤ì¼€ì¼
    set(gca,'FontSize',14);

    %% =========================================================================
    % 5) 2D Heatmap (Contourf)
    %% =========================================================================
    figure(fig_id); clf; set(gcf,'Color','w');
    fig_id = fig_id + 1;

    contourf(DUTY, TPER, Z, 40, 'LineColor','none');
    colorbar;

    xlabel('Duty');
    ylabel('Pulse Period (s)');
    title(sprintf('\\DeltaPlating Heatmap (stage mode = %d)', mode_target));

    set(gca,'YScale','log');
    set(gca,'FontSize',14);

end
